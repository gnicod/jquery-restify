(function(t){function s(s,e){this.options=t.extend({},i,e),this.form=s,this.json={},this._defaults=i,this._name="restify",this.init()}var i={root:"",fields:{},excluded:[],append:[],url:"",type:"",callback:function(){}};s.prototype={init:function(){var s=this,i=this.form.find("input:submit");void 0!==this.options.btn&&(i=t("#"+this.options.btn)),i.live("click",function(t){return s.form.find(".restify-msg").hide(),s.form.find(".restify-wrap").removeClass("restify-err"),s.parseForm(this.form,this.options),t.preventDefault(),!1}),this.setFormDefault("root","name","root"),this.setFormDefault("url","action","/"),this.setFormDefault("type","method","PUT")},setFormDefault:function(t,s,i){this.options[t]=""===this.options[t]&&""!==this.form.attr(s)&&void 0!==this.form.attr(s)?this.form.attr(s):i},parseForm:function(){var s={},i=this;t(this.form).find("input[type='text'],select,input[type='hidden'],input[type='password'],input[type='radio']:checked,textarea").each(function(){0>t.inArray(this.name,i.options.excluded)&&(s[this.name]=t(this).val())}),t(this.form).find("input[type='checkbox']").each(function(){if("[]"===this.name.substr(this.name.length-2)){var e=this.name.substr(0,this.name.length-2);void 0===s[e]&&(s[e]=[])}if(0>t.inArray(this.name,i.options.excluded))if("[]"===this.name.substr(this.name.length-2)){if(t(this).is(":checked")){var e=this.name.substr(0,this.name.length-2);s[e].push(t(this).val())}}else s[this.name]=t(this).is(":checked")}),this.json[this.options.root]=s;for(var s in this.options.append)this.json[this.options.root][s]=this.options.append[s];this.preprocess()},preprocess:function(){if(void 0!==this.options.preprocess)for(var t in this.options.preprocess){var s=this.options.preprocess[t];this.json[this.options.root][t]=s(this.json[this.options.root][t])}this.send(JSON.stringify(this.json))},send:function(s){if(!this.isValid())return!1;var i=this;this.options.type,t.ajax({url:i.options.url,type:i.options.type,data:s,dataType:"json"}).always(function(t){i.options.callback(t,s)})},isValid:function(){var s=!1;for(var i in this.options.fields){var e=t(i);if(this.checkLenght(e,this.options.fields[i]["min-length"],this.options.fields[i]["max-length"])||(s=!0),void 0!==this.options.fields[i].custom&&void 0!==this.options.fields[i].custom.fn){var o=window[this.options.fields[i].custom.fn]||function(){return!0};o(e)||(this.setErrorMessage(e,this.options.fields[i].custom.message),s=!0)}if(void 0!==this.options.fields[i].regexp&&void 0!==this.options.fields[i].regexp.pattern){var n=RegExp(this.options.fields[i].regexp.pattern);n.test(e.val())||(this.setErrorMessage(e,this.options.fields[i].regexp.message),s=!0)}}return!s},checkLenght:function(t,s,i){var e=!0,o=!0;return void 0!==s&&s>t.val().length&&(e=!1,this.setErrorMessage(t,"min length "+s)),void 0!==i&&t.val().length>i&&(o=!1,this.setErrorMessage(t,"max length "+i)),e&&o},setErrorMessage:function(t,s){t.parent().hasClass("restify-wrap")?(t.parent().addClass("restify-err"),t.parent().find(".restify-msg").text(s).show()):(t.wrapAll('<span class="restify-wrap restify-err" />'),t.parent().append('<span class="restify-msg">'+s+"</span>")),t.focus()}},t.fn.restify=function(i){var e=null;return this.each(function(){e=new s(t(this),i)}),e}})(window.jQuery);